name: deliver-web

on:
  push:
    branches:
      - main
    paths:
      - "webapp/**"
      - ".github/workflows/cd.yml"
  workflow_dispatch:

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    env:
      PROJECT_ID: minwarikan
      REGION: asia-northeast1
      SERVICE: minwari-webapp
      REPOSITORY: minwari

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_GITHUB_ACTIONS_SA }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker "$REGION-docker.pkg.dev" --quiet

      - name: Install dotenvx (pinned)
        run: |
          DOTENVX_VERSION="1.51.4"
          DOTENVX_TARBALL="dotenvx-${DOTENVX_VERSION}-linux-amd64.tar.gz"
          DOTENVX_URL="https://github.com/dotenvx/dotenvx/releases/download/v${DOTENVX_VERSION}/${DOTENVX_TARBALL}"
          DOTENVX_SHA256="a427ef5e52200c8c411c696ca0374e122f775ba20087c35a6cd44d33ee07c412"
          curl -sSfL -o "$DOTENVX_TARBALL" "$DOTENVX_URL"
          echo "${DOTENVX_SHA256}  ${DOTENVX_TARBALL}" | sha256sum -c -
          tar -xzf "$DOTENVX_TARBALL"
          sudo install -m 0755 dotenvx /usr/local/bin/dotenvx

      - name: Decrypt .env.production
        env:
          DOTENV_PRIVATE_KEY_PRODUCTION: ${{ secrets.DOTENV_PRIVATE_KEY_PRODUCTION }}
        run: dotenvx decrypt -f webapp/.env.production --stdout > webapp/.env.production

      - name: Build Docker image
        run: |
          IMAGE="$REGION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/$SERVICE:${{ github.sha }}"
          docker buildx build --platform linux/amd64 -t "$IMAGE" --load ./webapp
          echo "IMAGE=$IMAGE" >> "$GITHUB_ENV"

      - name: Push Docker image
        run: docker push "$IMAGE"

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy "$SERVICE" \
            --image "$IMAGE" \
            --region "$REGION" \
            --project "$PROJECT_ID" \
            --platform managed \
            --allow-unauthenticated \
            --memory 256Mi \
            --cpu 1 \
            --cpu-throttling \
            --quiet
